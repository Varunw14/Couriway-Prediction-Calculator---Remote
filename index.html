<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<a href="https://www.twitch.tv/couriway" target="_blank" rel="noopener noreferrer">
  <img src="couriway_logo.png" alt="Couri Logo" class="logo">
</a>
<title>Couriway Prediction Calculator</title>
<link href="/images/favicon.ico" rel="icon" type="image/x-icon"/>
<style>

.logo {
  position: absolute;
  top: 12px;
  left: 12px;
  width: 50px;
  height: 50px;
  border-radius: 6px; /* rounded corners */
  object-fit: cover; /* makes sure square images scale nicely */
}

/* Prevent overlap between Date and # of Runs in Chart 2 */
#chart-2 table.runs-table{
  table-layout: fixed; /* enforce column widths */
  width: 100%;
}
#chart-2 table.runs-table th:nth-child(1),
#chart-2 table.runs-table td:nth-child(1){
  /* Date column */
  white-space: nowrap;   /* keep on one line */
  overflow: visible;     /* allow measuring true width */
}
#chart-2 table.runs-table th:nth-child(2),
#chart-2 table.runs-table td:nth-child(2){
  /* # of Runs column */
  text-align: center;
  white-space: nowrap;
  overflow: visible;
}

    :root {
      --bg: #2e1d4d;
      --panel: #3b2966;
      --panel-elev: #483070;
      --text: #e5e7eb;
      --muted: #c4b3de;
      --accent: #7a4cd9;
      --accent-hover: #9d6af5;
      --border: #5a3c87;
      --error: #fca5a5;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --tab-bg: #3b2966;
      --tab-active-bg: #483070;
      --tab-hover: #4b3375;
      --focus: #bca3ff;
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 2rem;
      background: radial-gradient(1200px 800px at 20% -10%, #483070 0%, #2e1d4d 100%);
      color: var(--text);
    }
    .page-title {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin-bottom: 1rem;
      text-align: center;
      color: #fff;
    }

    /* Tabs */
    .tab-panel {
      margin-top: 0.9rem;
    }

    .controls, .card {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-elev) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 1.25rem;
      max-width: 1200px;
      margin: 0 auto 1.25rem auto;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .controls label { font-weight: 600; color: var(--text); }
    .controls input[type="number"] {
      width: 170px;
      padding: 0.5rem 0.7rem;
      border: 1px solid var(--border);
      background: #3b2966;
      color: var(--text);
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
    }
    .controls input::placeholder { color: #b59ed6; }
    .controls button {
      padding: 0.55rem 1rem;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.15s ease;
    }
    .controls button:hover { filter: brightness(1.08); }
    .controls button:active { transform: translateY(1px); }
    .controls button:disabled { opacity: 0.5; cursor: not-allowed; }
    h1, h2, h3 { margin: 0 0 0.25rem 0; }
    h2 { font-size: 1.3rem; }
    .status { font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--muted); }
    .metric { font-weight: 700; margin-bottom: 0.45rem; color: var(--text); }
    .spacer { height: 12px; }
    .error { color: var(--error); white-space: pre-wrap; }
    .toggle-btn {
      display: inline-block;
      margin: 0.5rem 0;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      background: #3b2966;
      color: var(--text);
      cursor: pointer;
    }
    .toggle-btn:hover { background: #4b3375; }
    .table-container { margin-top: 1rem; }
    .collapsed { display: none; }
    .hidden { display: none; }

    /* Google Table purple theming */
    .google-visualization-table-table,
    .google-visualization-table-table * {
      color: var(--text) !important;
      background: transparent !important;
      border-color: var(--border) !important;
    }
    .google-visualization-table-tr-even { background: rgba(255,255,255,0.06) !important; }
    .google-visualization-table-tr-odd { background: rgba(255,255,255,0.03) !important; }
    .google-visualization-table-th { font-weight: 700 !important; }
    .google-visualization-table-div-page { color: var(--muted) !important; }
  
    .tabs {
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:22px;
    }
    .tab {
      padding:10px 16px;
      border:1px solid var(--border);
      border-bottom:2px solid transparent;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      color:var(--text);
      border-radius: 12px;
      cursor:pointer;
      transition: all .2s ease;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .tab[aria-selected="true"] {
      background: linear-gradient(180deg, rgba(187,167,255,0.18), rgba(187,167,255,0.06));
      border-color: var(--accent);
      border-bottom-color: var(--accent);
      transform: translateY(-1px);
    }

  
    /* Stronghold grid layout */
    .row{display:grid; gap:14px}
    @media (min-width:900px){ .row{ grid-template-columns: 1.2fr 1fr; } }
    .grid-3{display:grid; gap:12px}
    @media (min-width:700px){ .grid-3{ grid-template-columns: repeat(3,1fr);} }

    label{ display:block; font-weight:600; margin-bottom:6px; }
    input[type="number"], input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background: rgba(255,255,255,0.05); color:var(--text); outline:none;
    }

    /* Stronghold "Calculate" button style (same as Load Data) */
    .calc-btn {
      padding: 0.55rem 1rem;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.15s ease;
    }
    .calc-btn:hover { filter: brightness(1.08); }
    .calc-btn:active { transform: translateY(1px); }
    .calc-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  
    /* 100K Statistics: responsive charts grid */
    .charts-grid{
      display:grid;
      gap:14px;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width:560px){ .charts-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width:900px){ .charts-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width:1200px){ .charts-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width:1500px){ .charts-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

    .chart-card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-elev) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 0.75rem;
      min-height: 220px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .chart-card .chart-slot{
      width:100%;
      height:100%;
    }
    .chart-placeholder{
      opacity:0.65;
      font-size:0.95rem;
      color:var(--muted);
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }

    
    .runs-table td:last-child {
      text-align: right;
      color: var(--text);
    }


    


    


    


    /* Auto-fit: base styles; JS will set exact font-size per cell */
    .runs-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .runs-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      white-space: nowrap;      /* keep one line */
      overflow: visible;        /* allow full text (we'll shrink to fit) */
      line-height: 1.1;
    }
    .runs-table td:first-child {
      font-weight: 600;
      color: var(--muted);
    }
    .runs-title {
      text-align:center;
      margin: 0 0 0.5rem 0;
      font-weight: 700;
      color: var(--text);
      line-height: 1.1;
      white-space: nowrap;
    }


    


    


    /* Ensure chart titles have no preset font-size; JS will maximize them */
    .chart-slot h3 {
      text-align: center;
      margin: 0.5rem 0;
      font-weight: 700;
      color: var(--text);
      line-height: 1.15;
      white-space: nowrap; /* single line */
    }


/* Live status pill styles */
.live-pill{
  position: absolute;
  top: 20px;
  left: 70px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 12px;
  line-height: 1;
  box-shadow: var(--shadow);
  user-select: none;
}

.live-dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  display: inline-block;
  background: #aaa;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.2) inset;
}

.live-pill.is-live .live-dot{ background: #22c55e; }
.live-pill.is-off  .live-dot{ background: #ef4444; }

</style>
<script src="https://www.gstatic.com/charts/loader.js">
    // ---- Stronghold calc ----
    
    // ---- Stronghold calc (compat) ----
    function strongholdCalc() {
      var xEl = document.getElementById('ow-x');
      var zEl = document.getElementById('ow-z');
      var a1El = document.getElementById('angle-1');
      var a2El = document.getElementById('angle-2');
      var scEl = document.getElementById('sub-chunk');

      var errEl = document.getElementById('stronghold-error');
      var outCard = document.getElementById('stronghold-output-card');
      var coordsEl = document.getElementById('stronghold-coords');

      function showErr(msg) {
        if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
        if (outCard) outCard.classList.remove('hidden');
        if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: —, —';
      }
      function hideErr() {
        if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
      }

      var x = parseFloat(xEl ? xEl.value : '');
      var z = parseFloat(zEl ? zEl.value : '');
      var a1 = parseFloat(a1El ? a1El.value : '');
      var a2 = parseFloat(a2El ? a2El.value : '');
      var sc = parseFloat(scEl ? scEl.value : '');

      if (!(isFinite(x) && isFinite(z) && isFinite(a1) && isFinite(a2) && isFinite(sc))) {
        showErr('Please enter valid numbers for all fields.');
        return;
      }
      if (sc < 0 || sc > 8) {
        showErr('Sub-Chunk must be between 0 and 8.');
        return;
      }

      var diff = Math.abs(a1 - a2);
      var rad = diff * Math.PI / 180;
      var t = Math.tan(rad);
      if (!isFinite(t) || Math.abs(t) < 1e-12) {
        showErr('Angles are too similar; tan(Δ) is near zero. Please adjust inputs.');
        return;
      }
      var K = 2 / t; // 2 / tan(|a1 - a2|)
      var scScale = (sc / 8.0);
      var xOvernet = x / 8.0;
      var zOvernet = z / 8.0;

      var x1 = null, z1 = null;

      function inRange(a, lo, hi) { return a >= lo && a <= hi; }

      if (inRange(a1, -90, -45.1)) {
        x1 = ( K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, -135, -90.1)) {
        x1 = ( K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, -180, -135.1)) {
        z1 = ( -K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else if (inRange(a1, 135, 180)) {
        z1 = ( -K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, 90, 134.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, 45, 89.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, 0, 44.9)) {
        z1 = ( K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, -45, -0.1)) {
        z1 = ( K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else {
        showErr('1st Angle of Throw is outside all specified ranges.');
        return;
      }

      hideErr();
      if (outCard) outCard.classList.remove('hidden');

      var xf = isFinite(x1) ? Math.round(x1) : '—';
      var zf = isFinite(z1) ? Math.round(z1) : '—';
      if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: ' + xf + ', ' + zf;
      var owEl = document.getElementById('stronghold-overworld');
      var x2 = (isFinite(x1) ? Math.round(x1) * 8 : '—');
      var z2 = (isFinite(z1) ? Math.round(z1) * 8 : '—');
      if (owEl) owEl.textContent = 'Stronghold Overworld Coordinates: ' + x2 + ', ' + z2;      // Optional: scroll into view
      if (outCard && outCard.scrollIntoView) { outCard.scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }

      function hideErr() {
        if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
      }

      const x = parseFloat(xStr);
      const z = parseFloat(zStr);
      const a1 = parseFloat(a1Str);
      const a2 = parseFloat(a2Str);
      const sc = parseFloat(scStr);

      if (![x,z,a1,a2,sc].every(v => Number.isFinite(v))) {
        showErr('Please enter valid numbers for all fields.');
        return;
      }
      if (sc < 0 || sc > 8) {
        showErr('Sub-Chunk must be between 0 and 8.');
        return;
      }

      const diff = Math.abs(a1 - a2);
      const rad = diff * Math.PI / 180;
      const t = Math.tan(rad);
      if (!Number.isFinite(t) || Math.abs(t) < 1e-12) {
        showErr('Angles are too similar; tan(Δ) is near zero. Please adjust inputs.');
        return;
      }
      const K = 8 / t; // 8 / tan(|a1 - a2|)
      const scScale = (sc / 8.0);
      const xOvernet = x / 8.0;
      const zOvernet = z / 8.0;

      let x1 = null, z1 = null;

      function inRange(a, lo, hi) { return a >= lo && a <= hi; }

      if (inRange(a1, -90, -45.1)) {
        x1 = ( K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, -135, -90.1)) {
        x1 = ( K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, -180, -135.1)) {
        z1 = ( -K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else if (inRange(a1, 135, 180)) {
        z1 = ( -K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, 90, 134.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, 45, 89.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, 0, 44.9)) {
        z1 = ( K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, -45, -0.1)) {
        z1 = ( K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else {
        showErr('1st Angle of Throw is outside all specified ranges.');
        return;
      }

      hideErr();
      if (outCard) outCard.classList.remove('hidden');

      const xf = Number.isFinite(x1) ? x1.toFixed(3) : '—';
      const zf = Number.isFinite(z1) ? z1.toFixed(3) : '—';
      if (coordsEl) coordsEl.textContent = `Stronghold Nether Coordinates: ${xf}, ${zf}`;

</script>
<script>
// ---- Tabs logic ----
    function initTabs() {
      const tablist = document.querySelector('[role="tablist"]');
      if (!tablist) return;
      const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
      const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

      function activateTab(tab) {
        tabs.forEach(t => t.setAttribute('aria-selected', String(t === tab)));
        panels.forEach(p => p.hidden = (p.id !== tab.getAttribute('aria-controls')));
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => activateTab(tab));
        tab.addEventListener('keydown', (e) => {
          const idx = tabs.indexOf(tab);
          if (e.key === 'ArrowRight') { e.preventDefault(); const n = tabs[(idx+1)%tabs.length]; n.focus(); activateTab(n); }
          if (e.key === 'ArrowLeft') { e.preventDefault(); const p = tabs[(idx-1+tabs.length)%tabs.length]; p.focus(); activateTab(p); }
        });
      });

      // Activate first selected tab on load
      const selected = tabs.find(t => t.getAttribute('aria-selected') === 'true') || tabs[0];
      if (selected) activateTab(selected);
    }

    // ---- Existing app logic ----
    const SPREADSHEET_ID = "1Tyw9fwdZgsHJoHzlE-0LPSEDOduRkZwL2UUNA-_4Xo4";
    const GID_PROCESSED = "1760430564";
    const GID_SECOND = "1885267609";

    let chartsReady = false;
    let t1Ready = false;
    let t2Ready = false;

    // Storage for stitching
    let t1Rows = []; // {date, igt, run}
    let t2Map = new Map(); // runNum(int) -> { predNum: number|null, predQ: string }
    let stitchedRows = []; // { igtNum:number|null, predNum:number|null, predQ:string }
    let rowLimitUsed = 50;

    // Cached numeric values for safe minimums
    let timeYesVal = null;
    let timeNoVal = null;
    let predYesVal = null;
    let predNoVal = null;

    google.charts.load("current", { packages: ["table"] });
    google.charts.setOnLoadCallback(() => {
      chartsReady = true;
      const btn = document.getElementById("load-btn");
      if (btn) btn.disabled = false;
      const hint = document.getElementById("hint");
      if (hint) hint.textContent = "Choose a Number of Runs as a sample size and the Current Prediction, then click Load Data.";
    });

    window.addEventListener('DOMContentLoaded', initTabs);

    function buildQuery(limit) {
      const n = Number(limit);
      const safe = (Number.isFinite(n) && n > 0) ? Math.floor(n) : 50;
      rowLimitUsed = safe;
      return `select * limit ${safe}`;
    }

    function clearOutputs() {
      t1Ready = false; t2Ready = false;
      t1Rows = [];
      t2Map.clear();
      stitchedRows = [];

      timeYesVal = null;
      timeNoVal  = null;
      predYesVal = null;
      predNoVal  = null;

      setText("status1", "—");
      setText("status2", "—");
      setText("statusStitched", "—");
      setText("propBelow", "—");
      setText("timeYes", "—");
      setText("timeNo", "—");
      setText("predSuccess", "—");
      setText("predBasedYes", "—");
      setText("predBasedNo", "—");
      setText("safeYes", "—");
      setText("safeNo", "—");
      hideAndClear("error1");
      hideAndClear("error2");
      setHTML("table1", "");
      setHTML("stitched-table", "");
      document.getElementById("stitched-card").classList.add("hidden");

      // Ensure second card initially visible (but will hide after stitch)
      document.getElementById("card2").classList.remove("hidden");

      // Reset toggles/collapsed
      setCollapsed('stitched', true);
      setText("toggle-btn-stitched", "Show Results Table");
    }

    function loadAll() {
      if (!chartsReady) return;
      const limitInput = document.getElementById("row-limit");
      const query = buildQuery(limitInput.value);
      clearOutputs();
      loadViaJSONP(GID_PROCESSED, "handleProcessed", query);
      loadViaJSONP(GID_SECOND, "handleSecond", query);
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }
    function setHTML(id, html) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    }
    function hideAndClear(id) {
      const el = document.getElementById(id);
      if (el) { el.style.display = "none"; el.textContent = ""; }
    }
    function setError(id, text) {
      const el = document.getElementById(id);
      if (el) { el.textContent = text; el.style.display = "block"; }
    }

    function loadViaJSONP(gid, handlerName, query) {
      const base = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq`;
      const params = new URLSearchParams({
        gid: gid,
        tq: query,
        tqx: `out:json;responseHandler:${handlerName}`
      });
      const url = `${base}?${params.toString()}`;
      const script = document.createElement("script");
      script.src = url;
      script.onerror = () => {
        if (gid === GID_PROCESSED) {
          setText("status1", "Failed to load data.");
          setError("error1", "Network or permissions error when loading the Google Sheets JSONP endpoint.");
        } else {
          setText("status2", "Failed to load data.");
          setError("error2", "Network or permissions error when loading the Google Sheets JSONP endpoint.");
        }
      };
      document.head.appendChild(script);
    }

    // === TABLE 1 handler (processed) ===
    function handleProcessed(response) {
      if (response.status !== "ok") {
        setText("status1", "Failed to load data.");
        const err = (response && response.errors && response.errors[0]) || {};
        setError("error1", "Google Sheets returned an error. " + (err.message || "Unknown error"));
        return;
      }
      try {
        const dataTable = new google.visualization.DataTable(response.table);

        t1Rows = [];
        for (let r = 1; r < dataTable.getNumberOfRows(); r++) { // skip first data row
          const val1 = dataTable.getValue(r, 0);   // col 1
          const val87 = dataTable.getValue(r, 86); // col 87
          const val93 = dataTable.getValue(r, 92); // col 93

          const out1 = (val1 == null) ? "" : String(val1);

          let out87 = (val87 == null) ? "" : String(val87);
          const parts = out87.split(":");
          if (parts.length === 3) out87 = parts[1];

          let runNum = null;
          if (typeof val93 === "string") {
            const num = parseInt(val93.replace(/,/g, ""), 10);
            if (!isNaN(num)) { runNum = num; }
          } else if (typeof val93 === "number") {
            runNum = val93;
          }

          if (runNum !== null && Number.isFinite(runNum)) {
            t1Rows.push({ date: out1, igt: out87, run: runNum });
          }
        }

        setText("status1", `Processed ${t1Rows.length} rows (limit ${rowLimitUsed}).`);
        t1Ready = true;
        maybeStitch();
      } catch (e) {
        setText("status1", "Failed to process table.");
        setError("error1", "Parsing/rendering error: " + (e.message || e));
      }
    }

    // === TABLE 2 handler (used for stitching only) ===
    function handleSecond(response) {
      if (response.status !== "ok") {
        setText("status2", "Failed to load data.");
        const err = (response && response.errors && response.errors[0]) || {};
        setError("error2", "Google Sheets returned an error. " + (err.message || e));
        return;
      }
      try {
        const dataTable = new google.visualization.DataTable(response.table);

        // Find columns by label: "run num", "Pred #", "Pred?"
        let runIdx = -1, predNumIdx = -1, predQIdx = -1;
        for (let c = 0; c < dataTable.getNumberOfColumns(); c++) {
          const raw = dataTable.getColumnLabel(c) || "";
          const label = raw.trim().toLowerCase();
          if (label === "run num") runIdx = c;
          if (raw.trim() === "Pred #") predNumIdx = c; // exact match
          if (raw.trim() === "Pred?") predQIdx = c;
        }

        if (runIdx === -1) {
          setText("status2", "Loaded, but couldn't find a 'run num' column to stitch on.");
        } else {
          t2Map.clear();
          for (let r = 1; r < dataTable.getNumberOfRows(); r++) { // skip first data row
            const keyVal = dataTable.getValue(r, runIdx);
            let keyInt = null;
            if (typeof keyVal === "string") {
              const num = parseInt(keyVal.replace(/,/g, ""), 10);
              if (!isNaN(num)) keyInt = num;
            } else if (typeof keyVal === "number") {
              keyInt = keyVal;
            }
            if (keyInt === null) continue;

            // Extract Pred # and Pred?
            let predNum = null;
            if (predNumIdx !== -1) {
              const pv = dataTable.getValue(r, predNumIdx);
              if (typeof pv === "string") {
                const num = parseInt(pv.replace(/,/g, ""), 10);
                predNum = isNaN(num) ? null : num;
              } else if (typeof pv === "number") {
                predNum = pv;
              } else {
                predNum = null;
              }
            }

            const predQ = (predQIdx !== -1)
              ? (dataTable.getValue(r, predQIdx) == null ? "" : String(dataTable.getValue(r, predQIdx)))
              : "";

            t2Map.set(keyInt, { predNum, predQ });
          }
          setText("status2", `Loaded ${t2Map.size} stitchable rows (limit ${rowLimitUsed}).`);
        }

        t2Ready = true;
        maybeStitch();
      } catch (e) {
        setText("status2", "Failed to parse second table.");
        setError("error2", "Parsing/rendering error: " + (e.message || e));
      }
    }

    // Stitch when both are ready
    function maybeStitch() {
      if (!t1Ready || !t2Ready) return;

      // Build stitched DataTable: first table's 3 cols + "Pred #" + "Pred?"
      const stitched = new google.visualization.DataTable();
      stitched.addColumn("string", "Date Played (EST)");
      stitched.addColumn("string", "IGT");
      stitched.addColumn("number", "run number");
      stitched.addColumn("number", "Pred #");
      stitched.addColumn("string", "Pred?");

      let joinedCount = 0;
      const igtValues = []; // numeric IGTs for proportion calc
      stitchedRows = [];

      t1Rows.forEach(({ date, igt, run }) => {
        const match = t2Map.get(run);
        if (match) {
          const { predNum, predQ } = match;
          stitched.addRow([date, igt, run, predNum, predQ]);
          joinedCount++;

          const igtNum = (igt == null) ? NaN : parseFloat(String(igt).trim());
          if (!Number.isNaN(igtNum)) igtValues.push(igtNum);

          stitchedRows.push({
            igtNum: Number.isNaN(igtNum) ? null : igtNum,
            predNum: (typeof predNum === "number" && Number.isFinite(predNum)) ? predNum : null,
            predQ: predQ == null ? "" : String(predQ)
          });
        }
      });

      // Draw stitched table
      const table = new google.visualization.Table(document.getElementById("stitched-table"));
      table.draw(stitched, { showRowNumber: true, width: "100%", allowHtml: true });

      // Show card, keep table collapsed by default
      document.getElementById("stitched-card").classList.remove("hidden");
      setCollapsed('stitched', true);
      setText("toggle-btn-stitched", "Show Results Table");
      document.getElementById("card2").classList.add("hidden");

      setText("statusStitched", `Stitched ${joinedCount} rows (limit ${rowLimitUsed}) -> ${rowLimitUsed-joinedCount-1} current version runs in sample size`);

      // Compute metrics
      computeProportionBelow(igtValues);
      computePredSuccess(stitchedRows);
    }

    function computeProportionBelow(igtValues) {
      const predInput = document.getElementById("current-pred");
      const raw = predInput ? predInput.value : "";
      const threshold = parseFloat(String(raw).trim());
      if (!Number.isFinite(threshold)) {
        setText("propBelow", "Enter a numeric Current Prediction to compute proportion.");
        setText("timeYes", "—");
        setText("timeNo", "—");
        timeYesVal = null; timeNoVal = null;
        computeSafeMinimums();
        return;
      }
      const valid = igtValues.filter(v => Number.isFinite(v));
      if (valid.length === 0) {
        setText("propBelow", "No valid IGT values to compute proportion.");
        setText("timeYes", "—");
        setText("timeNo", "—");
        timeYesVal = null; timeNoVal = null;
        computeSafeMinimums();
        return;
      }
      const belowCount = valid.reduce((acc, v) => acc + (v < threshold ? 1 : 0), 0);
      const proportion = belowCount / valid.length;
      setText("propBelow", `Proportion of IGT < Current Prediction: ${proportion.toFixed(4)} (${belowCount}/${valid.length})`);

      // Time-based Yes/No
      let tYes = null, tNo = null;
      if (proportion > 0) {
        tYes = 1 / proportion;
        setText("timeYes", `Time-based Yes: ${tYes.toFixed(4)}`);
      } else {
        setText("timeYes", "Time-based Yes: ∞ (proportion = 0)");
        tYes = Infinity;
      }
      if (proportion < 1) {
        tNo = 1 / (1 - proportion);
        setText("timeNo", `Time-based No: ${tNo.toFixed(4)}`);
      } else {
        setText("timeNo", "Time-based No: ∞ (proportion = 1)");
        tNo = Infinity;
      }
      timeYesVal = tYes;
      timeNoVal  = tNo;
      computeSafeMinimums();
    }

    function computePredSuccess(rows) {
      const predInput = document.getElementById("current-pred");
      const raw = predInput ? predInput.value : "";
      const target = parseFloat(String(raw).trim());
      if (!Number.isFinite(target)) {
        setText("predSuccess", "Enter a numeric Current Prediction to compute proportion of pred success.");
        setText("predBasedYes", "—");
        setText("predBasedNo", "—");
        predYesVal = null; predNoVal = null;
        computeSafeMinimums();
        return;
      }
      const matched = rows.filter(r => r.predNum !== null && r.predNum === target);
      if (matched.length === 0) {
        setText("predSuccess", "Proportion of Pred Success: 0.0000 (0/0 matched to Current Prediction)");
        setText("predBasedYes", "Pred-based Yes: ∞ (proportion = 0)");
        setText("predBasedNo", "Pred-based No: 1.0000");
        predYesVal = Infinity;
        predNoVal = 1.0;
        computeSafeMinimums();
        return;
      }
      const yCount = matched.reduce((acc, r) => acc + ((r.predQ || '').trim().toUpperCase() === 'Y' ? 1 : 0), 0);
      const proportion = yCount / matched.length;
      setText("predSuccess", `Proportion of Pred Success: ${proportion.toFixed(4)} (${yCount}/${matched.length} with Pred? = Y)`);

      // Pred-based Yes/No
      let pYes = null, pNo = null;
      if (proportion > 0) {
        pYes = 1 / proportion;
        setText("predBasedYes", `Pred-based Yes: ${pYes.toFixed(4)}`);
      } else {
        setText("predBasedYes", "Pred-based Yes: ∞ (proportion = 0)");
        pYes = Infinity;
      }
      if (proportion < 1) {
        pNo = 1 / (1 - proportion);
        setText("predBasedNo", `Pred-based No: ${pNo.toFixed(4)}`);
      } else {
        setText("predBasedNo", "Pred-based No: ∞ (proportion = 1)");
        pNo = Infinity;
      }
      predYesVal = pYes;
      predNoVal  = pNo;
      computeSafeMinimums();
    }

    function computeSafeMinimums() {
      const safeYesEl = document.getElementById("safeYes");
      const safeNoEl = document.getElementById("safeNo");
      if (!safeYesEl || !safeNoEl) return;

      function maxPretty(a, b) {
        if (a === Infinity || b === Infinity) return "∞";
        if (a == null && b == null) return "—";
        if (a == null) return (typeof b === "number") ? b.toFixed(4) : "—";
        if (b == null) return (typeof a === "number") ? a.toFixed(4) : "—";
        return Math.max(a, b).toFixed(4);
      }

      const safeYesText = maxPretty(predYesVal, timeYesVal);
      const safeNoText  = maxPretty(predNoVal,  timeNoVal);

      safeYesEl.textContent = `Safe Minimum Yes: ${safeYesText}`;
      safeNoEl.textContent  = `Safe Minimum No: ${safeNoText}`;
    }

    // Toggle helpers
    function setCollapsed(which, collapsed) {
      const containerId = which === 'stitched' ? "stitched-container" : "table-container2";
      const container = document.getElementById(containerId);
      if (!container) return;
      if (collapsed) container.classList.add("collapsed");
      else container.classList.remove("collapsed");
    }
    function toggleTable(which) {
      const btnId = which === 'stitched' ? "toggle-btn-stitched" : "toggle-btn2";
      const containerId = which === 'stitched' ? "stitched-container" : "table-container2";
      const container = document.getElementById(containerId);
      const btn = document.getElementById(btnId);
      if (container.classList.contains("collapsed")) {
        container.classList.remove("collapsed");
        btn.textContent = which === 'stitched' ? "Hide Results Table" : "Hide Table";
      } else {
        container.classList.add("collapsed");
        btn.textContent = which === 'stitched' ? "Show Results Table" : "Show Table";
      }
    }
  
    // ---- Stronghold calc (global) ----
    function strongholdCalc() {
      var xEl = document.getElementById('ow-x');
      var zEl = document.getElementById('ow-z');
      var a1El = document.getElementById('angle-1');
      var a2El = document.getElementById('angle-2');
      var scEl = document.getElementById('sub-chunk');

      var errEl = document.getElementById('stronghold-error');
      var outCard = document.getElementById('stronghold-output-card');
      var coordsEl = document.getElementById('stronghold-coords');

      function showErr(msg) {
        if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
        if (outCard) outCard.classList.remove('hidden');
        if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: —, —';
      }
      function hideErr() {
        if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
      }

      var x = parseFloat(xEl ? xEl.value : '');
      var z = parseFloat(zEl ? zEl.value : '');
      var a1 = parseFloat(a1El ? a1El.value : '');
      var a2 = parseFloat(a2El ? a2El.value : '');
      var sc = parseFloat(scEl ? scEl.value : '');

      if (!(isFinite(x) && isFinite(z) && isFinite(a1) && isFinite(a2) && isFinite(sc))) {
        showErr('Please enter valid numbers for all fields.');
        return;
      }
      if (sc < 0 || sc > 8) {
        showErr('Sub-Chunk must be between 0 and 8.');
        return;
      }

      var diff = Math.abs(a1 - a2);
      var rad = diff * Math.PI / 180;
      var t = Math.tan(rad);
      if (!isFinite(t) || Math.abs(t) < 1e-12) {
        showErr('Angles are too similar; tan(Δ) is near zero. Please adjust inputs.');
        return;
      }
      var K = 2 / t; // 2 / tan(|a1 - a2|)
      var scScale = (sc / 8.0);
      var xOvernet = x / 8.0;
      var zOvernet = z / 8.0;

      var x1 = null, z1 = null;

      function inRange(a, lo, hi) { return a >= lo && a <= hi; }

      if (inRange(a1, -90, -45.1)) {
        x1 = ( K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, -135, -90.1)) {
        x1 = ( K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, -180, -135.1)) {
        z1 = ( -K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else if (inRange(a1, 135, 180)) {
        z1 = ( -K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, 90, 134.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
      } else if (inRange(a1, 45, 89.9)) {
        x1 = ( -K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
      } else if (inRange(a1, 0, 44.9)) {
        z1 = ( K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
      } else if (inRange(a1, -45, -0.1)) {
        z1 = ( K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
      } else {
        showErr('1st Angle of Throw is outside all specified ranges.');
        return;
      }

      hideErr();
      if (outCard) outCard.classList.remove('hidden');

      var xf = isFinite(x1) ? Math.round(x1) : '—';
      var zf = isFinite(z1) ? Math.round(z1) : '—';
      if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: ' + xf + ', ' + zf;
      var owEl = document.getElementById('stronghold-overworld');
      var x2 = (isFinite(x1) ? Math.round(x1) * 8 : '—');
      var z2 = (isFinite(z1) ? Math.round(z1) * 8 : '—');
      if (owEl) owEl.textContent = 'Stronghold Overworld Coordinates: ' + x2 + ', ' + z2;      if (outCard && outCard.scrollIntoView) { outCard.scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }


    // ---- Stronghold: toggle working ----
    function toggleStrongholdWorking() {
      var c = document.getElementById('stronghold-working-container');
      var btn = document.getElementById('stronghold-working-toggle');
      if (!c || !btn) return;
      var collapsed = c.classList.contains('collapsed');
      if (collapsed) {
        c.classList.remove('collapsed');
        btn.textContent = 'Hide Working';
      } else {
        c.classList.add('collapsed');
        btn.textContent = 'Show Working';
      }
    }

    // ---- Stronghold: copy nether coords ----
    function copyNetherCoords() {
      var el = document.getElementById('stronghold-coords');
      if (!el) return;
      var txt = el.textContent || '';
      // Expect format: "Stronghold Nether Coordinates: X, Z"
      var idx = txt.indexOf(':');
      var payload = (idx >= 0) ? txt.slice(idx+1).trim() : txt.trim();
      function done(ok) {
        var btn = document.getElementById('copy-nether-btn');
        if (!btn) return;
        var old = btn.textContent;
        btn.textContent = ok ? 'Copied!' : 'Copy failed';
        setTimeout(function(){ btn.textContent = old; }, 1400);
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(payload).then(function(){ done(true); }, function(){ done(false); });
      } else {
        // Fallback
        var ta = document.createElement('textarea');
        ta.value = payload;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); done(true); } catch(e){ done(false); }
        document.body.removeChild(ta);
      }
    }

    // ---- Stronghold calc (with working; K = 2/t; whole-number output) ----
    function strongholdCalc() {
      var xEl = document.getElementById('ow-x');
      var zEl = document.getElementById('ow-z');
      var a1El = document.getElementById('angle-1');
      var a2El = document.getElementById('angle-2');
      var scEl = document.getElementById('sub-chunk');

      var errEl = document.getElementById('stronghold-error');
      var outCard = document.getElementById('stronghold-output-card');
      var coordsEl = document.getElementById('stronghold-coords');
      var workEl = document.getElementById('stronghold-working');

      function showErr(msg) {
        if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
        if (outCard) outCard.classList.remove('hidden');
        if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: —, —';
        if (workEl) workEl.textContent = '';
      }
      function hideErr() {
        if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
      }
      function fmt(n, d) { return (isFinite(n) ? n.toFixed(d) : String(n)); }

      var x = parseFloat(xEl ? xEl.value : '');
      var z = parseFloat(zEl ? zEl.value : '');
      var a1 = parseFloat(a1El ? a1El.value : '');
      var a2 = parseFloat(a2El ? a2El.value : '');
      var sc = parseFloat(scEl ? scEl.value : '');

      if (!(isFinite(x) && isFinite(z) && isFinite(a1) && isFinite(a2) && isFinite(sc))) {
        showErr('Please enter valid numbers for all fields.');
        return;
      }
      if (sc < 0 || sc > 8) {
        showErr('Sub-Chunk must be between 0 and 8.');
        return;
      }

      var steps = [];
      steps.push('Inputs:');
      steps.push('  OW X Coordinate = ' + x);
      steps.push('  OW Z Coordinate = ' + z);
      steps.push('  1st Angle of Throw = ' + a1);
      steps.push('  2nd Angle of Throw = ' + a2);
      steps.push('  Sub-Chunk = ' + sc);

      var diff = Math.abs(a1 - a2);
      var rad = diff * Math.PI / 180;
      var t = Math.tan(rad);
      if (!isFinite(t) || Math.abs(t) < 1e-12) {
        showErr('Angles are too similar; tan(Δ) is near zero. Please adjust inputs.');
        return;
      }
      var K = 2 / t; // 2 / tan(|a1 - a2|) per user
      var scScale = (sc / 8.0);
      var xOvernet = x / 8.0;
      var zOvernet = z / 8.0;

      steps.push('');
      steps.push('Δ = |a1 - a2| = ' + fmt(diff, 4) + '°');
      steps.push('radians = Δ × π / 180 = ' + fmt(rad, 6));
      steps.push('tan(Δ) = ' + fmt(t, 6));
      steps.push('K = 2 / tan(Δ) = ' + fmt(K, 6));
      steps.push('Sub-Chunk scale = sc / 8 = ' + fmt(scScale, 6));
      steps.push('OW→Nether scale: x/8 = ' + fmt(xOvernet, 6) + ', z/8 = ' + fmt(zOvernet, 6));

      var x1 = null, z1 = null, rule = '';

      function inRange(a, lo, hi) { return a >= lo && a <= hi; }

      if (inRange(a1, -90, -45.1)) {
        rule = 'Rule: a1 in [-90, -45.1]';
        x1 = ( K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
        steps.push(''); steps.push(rule);
        steps.push('x1 = K + x/8 = ' + fmt(K, 6) + ' + ' + fmt(xOvernet, 6));
        steps.push('z1 = (K)*(sc/8) + z/8 = ' + fmt(K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(zOvernet, 6));
      } else if (inRange(a1, -135, -90.1)) {
        rule = 'Rule: a1 in [-135, -90.1]';
        x1 = ( K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
        steps.push(''); steps.push(rule);
        steps.push('x1 = K + x/8 = ' + fmt(K, 6) + ' + ' + fmt(xOvernet, 6));
        steps.push('z1 = (-K)*(sc/8) + z/8 = ' + fmt(-K, 6) + ' * ' + ' ' + fmt(scScale, 6) + ' + ' + fmt(zOvernet, 6));
      } else if (inRange(a1, -180, -135.1)) {
        rule = 'Rule: a1 in [-180, -135.1]';
        z1 = ( -K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
        steps.push(''); steps.push(rule);
        steps.push('z1 = -K + z/8 = ' + fmt(-K, 6) + ' + ' + fmt(zOvernet, 6));
        steps.push('x1 = (K)*(sc/8) + x/8 = ' + fmt(K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(xOvernet, 6));
      } else if (inRange(a1, 135, 180)) {
        rule = 'Rule: a1 in [135, 180]';
        z1 = ( -K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
        steps.push(''); steps.push(rule);
        steps.push('z1 = -K + z/8 = ' + fmt(-K, 6) + ' + ' + fmt(zOvernet, 6));
        steps.push('x1 = (-K)*(sc/8) + x/8 = ' + fmt(-K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(xOvernet, 6));
      } else if (inRange(a1, 90, 134.9)) {
        rule = 'Rule: a1 in [90, 134.9]';
        x1 = ( -K + xOvernet );
        z1 = ( (-K) * scScale + zOvernet );
        steps.push(''); steps.push(rule);
        steps.push('x1 = -K + x/8 = ' + fmt(-K, 6) + ' + ' + fmt(xOvernet, 6));
        steps.push('z1 = (-K)*(sc/8) + z/8 = ' + fmt(-K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(zOvernet, 6));
      } else if (inRange(a1, 45, 89.9)) {
        rule = 'Rule: a1 in [45, 89.9]';
        x1 = ( -K + xOvernet );
        z1 = ( ( K ) * scScale + zOvernet );
        steps.push(''); steps.push(rule);
        steps.push('x1 = -K + x/8 = ' + fmt(-K, 6) + ' + ' + fmt(xOvernet, 6));
        steps.push('z1 = (K)*(sc/8) + z/8 = ' + fmt(K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(zOvernet, 6));
      } else if (inRange(a1, 0, 44.9)) {
        rule = 'Rule: a1 in [0, 44.9]';
        z1 = ( K + zOvernet );
        x1 = ( (-K) * scScale + xOvernet );
        steps.push(''); steps.push(rule);
        steps.push('z1 = K + z/8 = ' + fmt(K, 6) + ' + ' + fmt(zOvernet, 6));
        steps.push('x1 = (-K)*(sc/8) + x/8 = ' + fmt(-K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(xOvernet, 6));
      } else if (inRange(a1, -45, -0.1)) {
        rule = 'Rule: a1 in [-45, -0.1]';
        z1 = ( K + zOvernet );
        x1 = ( ( K ) * scScale + xOvernet );
        steps.push(''); steps.push(rule);
        steps.push('z1 = K + z/8 = ' + fmt(K, 6) + ' + ' + fmt(zOvernet, 6));
        steps.push('x1 = (K)*(sc/8) + x/8 = ' + fmt(K, 6) + ' * ' + fmt(scScale, 6) + ' + ' + fmt(xOvernet, 6));
      } else {
        showErr('1st Angle of Throw is outside all specified ranges.');
        return;
      }

      hideErr();
      if (outCard) outCard.classList.remove('hidden');

      var xf = isFinite(x1) ? Math.round(x1) : '—';
      var zf = isFinite(z1) ? Math.round(z1) : '—';
      if (coordsEl) coordsEl.textContent = 'Stronghold Nether Coordinates: ' + xf + ', ' + zf;

      steps.push(''); steps.push('Result (Nether):');
      steps.push('  x1 = ' + xf);
      steps.push('  z1 = ' + zf);

      if (workEl) workEl.textContent = steps.join('\n');
      // Also update overworld line if present
      var owEl = document.getElementById('stronghold-overworld');
      var x2 = (isFinite(x1) ? Math.round(x1) * 8 : '—');
      var z2 = (isFinite(z1) ? Math.round(z1) * 8 : '—');
      if (owEl) owEl.textContent = 'Stronghold Overworld Coordinates: ' + x2 + ', ' + z2;
    }
</script>
<style>
#chart3-total {
  font-size: 0.85em;
  white-space: normal;
  word-break: break-word;
}
</style>
</head>
<body>

<!-- Live status pill next to the logo -->
<div class="live-pill" id="twitch-live-pill" aria-live="polite" title="Twitch live status">
  <span class="live-dot" id="twitch-live-dot"></span>
  <span id="twitch-live-text">Checking…</span>
</div>

<script>
// === Chart-2 "Today" (EST) — v7 unified boot (defines debugChart2TodayScan & forceChart2TodayUpdate) ===
(function(){
  console.info("[Chart-2 Today v7] boot");

  const pad = n => String(n).padStart(2,'0');
  const formatMMDDYYYY = d => `${pad(d.getMonth()+1)}/${pad(d.getDate())}/${d.getFullYear()}`;
  const formatISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function nyDSTOn(date){
    const y = date.getUTCFullYear();
    function nthDowOfMonth(n, dow, month){
      const d = new Date(Date.UTC(y, month, 1));
      const firstDow = d.getUTCDay();
      const day = 1 + ((7 + dow - firstDow) % 7) + (n-1)*7;
      return new Date(Date.UTC(y, month, day));
    }
    const dstStart = nthDowOfMonth(2, 0, 2);
    const dstEnd   = nthDowOfMonth(1, 0, 10);
    return date >= dstStart && date < dstEnd;
  }

  function computeNewYorkNow(){
    const nowUTC = new Date();
    try{
      const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).formatToParts(nowUTC);
      const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      const dt = new Date(`${map.year}-${map.month}-${map.day}T${map.hour}:${map.minute}:${map.second}`);
      return { date: dt, via: 'Intl' };
    }catch(e){
      const isDST = nyDSTOn(nowUTC);
      const offsetHours = isDST ? -4 : -5;
      const dt = new Date(nowUTC.getTime() + offsetHours*60*60*1000);
      return { date: dt, via: 'Fallback(' + (isDST ? 'EDT' : 'EST') + ')' };
    }
  }

  function todayEST(){
    const ny = computeNewYorkNow();
    const d = ny.date;
    const t = { mmddyyyy: formatMMDDYYYY(d), iso: formatISO(d), via: ny.via };
    console.warn("[Chart-2 Today v7] EST today:", t.mmddyyyy, "| ISO:", t.iso, "| via:", t.via);
    return t;
  }

  function looksLikeDateObject(o){
    if (!o || typeof o !== 'object') return false;
    const cand = (o.displayDate || o.date || o.Date || o.day || o.Day);
    if (!cand) return false;
    const s = String(cand).trim();
    return /^\d{2}\/\d{2}\/\d{4}$/.test(s) || /^\d{4}-\d{2}-\d{2}$/.test(s);
  }
  function extractDateString(o){
    const cand = (o.displayDate || o.date || o.Date || o.day || o.Day);
    return String(cand).trim();
  }
  function normalizeToMMDDYYYY(s){
    s = String(s).trim();
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const [y,m,d] = s.split('-');
      return m+'/'+d+'/'+y;
    }
    return s;
  }

  const PREFERRED_KEYS = [
    'col8788AveragesByDateAll','col8788AveragesByDateFull','col8788AveragesByDate',
    'allAveragesByDate','averagesByDateAll','averagesByDate'
  ];

  function findCandidateArraysOnWindow(){
    const found = [];
    PREFERRED_KEYS.forEach(k => { if (Array.isArray(window[k])) found.push({key:k, arr:window[k]}); });
    if (!found.length){
      for (const k in window){
        try{
          const v = window[k];
          if (Array.isArray(v) && v.length && v.slice(0,5).some(looksLikeDateObject)){
            found.push({key:k, arr:v});
          }
        }catch(_e){}
      }
    }
    return found;
  }

  function buildFullAveragesList(){
    const candidates = findCandidateArraysOnWindow();
    const byDate = new Map();
    const provenance = [];
    candidates.forEach(({key, arr}) => {
      provenance.push(key);
      arr.forEach(item => {
        if (!looksLikeDateObject(item)) return;
        const dateStr = normalizeToMMDDYYYY(extractDateString(item));
        if (!dateStr) return;
        const prev = byDate.get(dateStr);
        const score = (item && typeof item.avgSeconds === 'number' ? 2 : 0) + (item && typeof item.count === 'number' ? 1 : 0);
        const prevScore = prev ? ((typeof prev.avgSeconds === 'number' ? 2 : 0) + (typeof prev.count === 'number' ? 1 : 0)) : -1;
        if (score >= prevScore){
          byDate.set(dateStr, {
            displayDate: dateStr,
            avgSeconds: (typeof item.avgSeconds === 'number' ? item.avgSeconds : prev ? prev.avgSeconds : undefined),
            avgHMS: (item.avgHMS || (prev ? prev.avgHMS : undefined)),
            count: (typeof item.count === 'number' ? item.count : prev ? prev.count : undefined)
          });
        }
      });
    });
    let out = Array.from(byDate.values());
    out.sort((a,b)=>{
      const aa = (typeof a.avgSeconds === 'number') ? a.avgSeconds : Infinity;
      const bb = (typeof b.avgSeconds === 'number') ? b.avgSeconds : Infinity;
      if (aa !== bb) return aa - bb;
      return (a.displayDate || '').localeCompare(b.displayDate || '');
    });
    return { list: out, provenance, uniqueDates: out.length };
  }

  function updateTodayRowFull(){
    try{
      const t = todayEST();
      const { list, provenance, uniqueDates } = buildFullAveragesList();

      const preferredFound = PREFERRED_KEYS.filter(k => Array.isArray(window[k]));
      console.info("[Chart-2 Today v7] preferred arrays:", preferredFound.map(k => ({key:k,len:window[k]?.length||0})));
      console.log("[Chart-2 Today v7] full list size:", uniqueDates, "from:", provenance);

      if (!list.length){
        console.warn("[Chart-2 Today v7] no dates available yet (only top-10 may be exposed).");
        return false;
      }

      const idx = list.findIndex(it => String(it.displayDate).trim() === t.mmddyyyy);
      if (idx === -1){
        console.warn("[Chart-2 Today v7] today not found in full list:", t.mmddyyyy);
        return false;
      }

      const item = list[idx];
      const tbody = document.querySelector('#chart-2 table.runs-table tbody');
      if (!tbody){ console.warn("[Chart-2 Today v7] chart-2 tbody not found"); return false; }

      const rows = tbody.querySelectorAll('tr');
      const todayRow = rows[rows.length - 1];
      if (!todayRow){ console.warn("[Chart-2 Today v7] today row not found"); return false; }

      const cells = todayRow.querySelectorAll('td');
      if (cells[1]) { cells[1].textContent = String(item.count ?? '—'); cells[1].style.textAlign = 'center'; cells[1].style.whiteSpace = 'nowrap'; }
      if (cells[2]) { cells[2].textContent = String(item.avgHMS || '—'); }
      if (cells[3]) { cells[3].textContent = String(idx + 1); }

      if (window.__fitChart2CellText){
        if (cells[0]) window.__fitChart2CellText(cells[0], {minPx:10, maxPx:16, step:0.5});
        if (cells[1]) window.__fitChart2CellText(cells[1], {minPx:10, maxPx:16, step:0.5});
      }

      const todayObj = { dateKeyMMDDYYYY: t.mmddyyyy, dateKeyISO: t.iso, matchedIndex: idx, rank: idx+1,
                         avgSeconds: item.avgSeconds, avgHMS: item.avgHMS, count: item.count,
                         listSize: uniqueDates, provenance: provenance };
      console.log("[Chart-2 Today v7] ✅ populated Today row", todayObj);
      window.chart2Today = todayObj;

      try{
        const h = document.querySelector('#chart-2 h3, #chart-2 h2, #chart-2 .title') || document.querySelector('#chart-2');
        if (h){
          const existing = h.parentNode.querySelector('.today-est-badge');
          if (existing) existing.remove();
          const badge = document.createElement('div');
          badge.className = 'today-est-badge';
          badge.textContent = "Today (EST): " + t.mmddyyyy + " • in " + uniqueDates + " dates";
          badge.style.fontSize = '12px'; badge.style.opacity = '0.75'; badge.style.margin = '4px 0 8px';
          h.parentNode.insertBefore(badge, h.nextSibling);
        }
      }catch(_e){}

      return true;
    }catch(e){
      console.error("[Chart-2 Today v7] update error:", e);
      return false;
    }
  }

  // Manual hooks
  window.debugESTToday = function(){ return todayEST(); };
  window.debugChart2TodayScan = function(){
    const { list, provenance, uniqueDates } = buildFullAveragesList();
    console.info("[Chart-2 Today v7] scan:", {uniqueDates, provenance, sample:list.slice(0,3)});
    return {uniqueDates, provenance, sample:list.slice(0,3)};
  };
  window.forceChart2TodayUpdate = function(){ console.info("[Chart-2 Today v7] manual force update"); return updateTodayRowFull(); };

  function scheduleRetries(){
    let tries = 0;
    const maxTries = 600;
    const iv = setInterval(function(){
      tries++;
      if (updateTodayRowFull() || tries >= maxTries){
        clearInterval(iv);
      }
    }, 200);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', scheduleRetries, { once:true });
  } else {
    scheduleRetries();
  }
  window.addEventListener('load', function(){ setTimeout(updateTodayRowFull, 0); });

  (function hookNetwork(){
    try{
      if (window.fetch){
        const _fetch = window.fetch;
        window.fetch = function(){
          return _fetch.apply(this, arguments).then(function(res){
            setTimeout(updateTodayRowFull, 0);
            return res;
          });
        };
      }
      if (window.XMLHttpRequest){
        const _open = XMLHttpRequest.prototype.open;
        const _send = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(){ this.__chart2_hooked = true; return _open.apply(this, arguments); };
        XMLHttpRequest.prototype.send = function(){
          if (this.__chart2_hooked){
            this.addEventListener('loadend', function(){ setTimeout(updateTodayRowFull, 0); });
          }
          return _send.apply(this, arguments);
        };
      }
    }catch(e){
      console.warn("[Chart-2 Today v7] network hooks failed", e);
    }
  })();
})();
</script>
<div class="page-title">Couriway 100K Statistics Analysis</div>
<!-- Tabs -->
<div aria-label="Calculator sections" class="tabs" role="tablist">
<button aria-controls="panel-pred" aria-selected="true" class="tab" id="tab-pred" role="tab">Prediction Calculator</button>
<button aria-controls="panel-stronghold" aria-selected="false" class="tab" id="tab-stronghold" role="tab">Stronghold Sheetless</button>
<button aria-controls="panel-stats" aria-selected="false" class="tab" id="tab-stats" role="tab">100K Statistics</button></div>
<!-- Panels -->
<section aria-labelledby="tab-pred" class="tab-panel" id="panel-pred" role="tabpanel">
<!-- Controls -->
<div class="controls">
<label for="row-limit">Number of Runs:</label>
<input id="row-limit" min="1" step="50" type="number" value="500"/>
<label for="current-pred">Current Prediction:</label>
<input id="current-pred" placeholder="Enter prediction..." step="1" type="number"/>
<button disabled="" id="load-btn" onclick="loadAll()">Load Data</button>
<span id="hint" style="margin-left:0.25rem; color:var(--muted);">Loading chart library…</span>
</div>
<!-- Prediction Results -->
<div class="card hidden" id="stitched-card">
<h2>Prediction Results</h2>
<div aria-live="polite" class="status" id="statusStitched" role="status">—</div>
<div class="metric" id="propBelow">—</div>
<div class="metric" id="timeYes">—</div>
<div class="metric" id="timeNo">—</div>
<div class="spacer"></div>
<div class="metric" id="predSuccess">—</div>
<div class="metric" id="predBasedYes">—</div>
<div class="metric" id="predBasedNo">—</div>
<div class="spacer"></div>
<div class="metric" id="safeYes">—</div>
<div class="metric" id="safeNo">—</div>
<button class="toggle-btn" id="toggle-btn-stitched" onclick="toggleTable('stitched')">Show Results Table</button>
<div class="table-container collapsed" id="stitched-container">
<div aria-busy="true" id="stitched-table"></div>
</div>
</div>
<!-- Table 2 (hidden after stitch) -->
<div class="card" id="card2">
<h3>Prediction Results</h3>
<div class="status" id="status2">—</div>
<pre class="error" id="error2" style="display:none;"></pre>
</div>
</section>
<section aria-labelledby="tab-stronghold" class="tab-panel" hidden="" id="panel-stronghold" role="tabpanel">
<div class="card">
<h2>Ender Eye Measurements</h2>
<div class="grid-3" id="stronghold-controls">
<div>
<label for="ow-x">Overworld X Coordinate</label>
<input id="ow-x" placeholder="e.g. 1234" step="1" type="number"/>
</div>
<div>
<label for="ow-z">Overworld Z Coordinate</label>
<input id="ow-z" placeholder="e.g. -567" step="1" type="number"/>
</div>
<div>
<label for="sub-chunk">Sub-Chunk</label>
<input id="sub-chunk" max="8" min="0" placeholder="0–8" step="1" type="number"/>
</div>
<div>
<label for="angle-1">1st Angle of Throw</label>
<input id="angle-1" placeholder="e.g. 37.5" step="0.1" type="number"/>
</div>
<div>
<label for="angle-2">2nd Angle of Throw</label>
<input id="angle-2" placeholder="e.g. 41.2" step="0.1" type="number"/>
</div>
<div style="display:flex;align-items:flex-end;justify-content:flex-start">
<button class="calc-btn" id="stronghold-calc-btn" onclick="strongholdCalc();" type="button">Calculate</button>
</div>
</div>
</div>
<div class="card hidden" id="stronghold-output-card">
<h2>Stronghold Coordinates</h2>
<div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
<div class="metric" id="stronghold-coords">Stronghold Nether Coordinates: x1, z1</div>
<button class="toggle-btn" id="copy-nether-btn" onclick="copyNetherCoords()" type="button">Copy</button>
</div>
<button class="toggle-btn" id="stronghold-working-toggle" onclick="toggleStrongholdWorking()" type="button">Show Working</button>
<div class="collapsed" id="stronghold-working-container" style="margin-top:0.5rem;"><h3 style="margin:0">Calculation Details</h3>
<pre id="stronghold-working" style="white-space:pre-wrap; margin-top:0.5rem; color: var(--muted)"></pre>
</div>
<div class="spacer"></div>
<div class="metric" id="stronghold-overworld">Stronghold Overworld Coordinates: x2, z2</div>
<pre class="error" id="stronghold-error" style="display:none;"></pre>
</div>
</section><section aria-labelledby="tab-stats" class="tab-panel" hidden="" id="panel-stats" role="tabpanel"><div class="card"><h2>100K Statistics</h2><div class="charts-grid"><div class="chart-card">
<div class="chart-slot" id="chart-1">
<h3 class="runs-title">Total Runs</h3>
<table class="runs-table">
<colgroup>
<col style="width:60%;"/>
<col style="width:40%;"/>
</colgroup>
<tbody>
<tr><td>Runs Completed</td><td id="runs-completed">—</td></tr>
<tr><td>Total Remaining</td><td id="total-remaining">—</td></tr>
<tr><td>Percentage Done</td><td id="percentage-done">—</td></tr>
<tr><td>Estimated Hours Left</td><td id="hours-remaining">—</td></tr>
<tr><td>Estimated Finish Date</td><td id="finish-date">—</td></tr>
</tbody>
</table>
</div>
</div>
<div class="chart-card">
<div class="chart-slot" id="chart-2">
<h3 id="chart2-title">Daily Average Rankings</h3>
<table class="runs-table">
<colgroup>
<col style="width:25%;"/>
<col style="width:25%;"/>
<col style="width:25%;"/>
<col style="width:25%;"/>
</colgroup>
<thead>
<tr>
<th style="font-size:0.85rem;">Date</th>
<th style="font-size:0.85rem;"># of Runs</th>
<th style="font-size:0.85rem;">Average Time</th>
<th style="font-size:0.85rem;">Rank</th>
</tr>
</thead>
<tbody>
<tr><td>Day 1</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>Day 2</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>Day 3</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>Day 4</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td>Day 5</td><td>—</td><td>—</td><td>—</td></tr>
<tr><td><strong>Today</strong></td><td>—</td><td>—</td><td>—</td></tr>
</tbody>
</table>
</div>
</div><div class="chart-card"><div class="chart-slot" id="chart-3">
<h3 class="runs-title">1.16.1 Stats</h3>
<table class="runs-table">
<colgroup>
<col style="width:60%;"/>
<col style="width:40%;"/>
</colgroup>
<tbody>
<tr><td>Average Time</td><td><span id="chart3-avg">—</span></td></tr>
<tr><td>Average Time (Last 10)</td><td><span id="chart3-avg10">—</span></td></tr>
<tr><td>Average Time (Last 100)</td><td><span id="chart3-avg100">—</span></td></tr>
<tr><td>Average Time (Last 1000)</td><td><span id="chart3-avg1000">—</span></td></tr>
<tr><td>Fastest Run</td><td><span id="chart3-fastest">—</span></td></tr>
<tr><td>Slowest Run</td><td><span id="chart3-slowest">—</span></td></tr>
<tr><td>Total Time Spent Running</td><td><span id="chart3-total">—</span></td></tr>
</tbody>
</table>
</div></div><div class="chart-card"><div class="chart-slot" id="chart-4">
<h3 class="runs-title">Top 10 Speedruns</h3>
<table class="runs-table">
<colgroup>
<col style="width:33%;"/>
<col style="width:33%;"/>
<col style="width:34%;"/>
</colgroup>
<thead>
<tr>
<th style="text-align:center;">Day</th>
<th style="text-align:center;">Time</th>
<th style="text-align:center;">Run</th>
</tr>
</thead>
<tbody><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr><tr><td style="text-align:center;">—</td><td style="text-align:center;">—</td><td style="text-align:center;">—</td></tr></tbody>
</table>
</div></div><div class="chart-card"><div class="chart-slot" id="chart-5">
<h3 class="runs-title">Nether Entries</h3>
<table class="runs-table">
<colgroup>
<col style="width:60%;"/>
<col style="width:40%;"/>
</colgroup>
<tbody><tr><td>Average Nether Entry</td><td><span id="chart5-entry1">—</span></td></tr>
<tr><td>Average Nether Entry (Last 10)</td><td><span id="chart5-entry2">—</span></td></tr>
<tr><td>Average Nether Entry (Last 100)</td><td><span id="chart5-entry3">—</span></td></tr>
<tr><td>Average Nether Entry (Last 1000)</td><td><span id="chart5-entry4">—</span></td></tr>
<tr><td>Fastest Entry</td><td><span id="chart5-entry5">—</span></td></tr>
<tr><td>Slowest Entry</td><td><span id="chart5-entry6">—</span></td></tr></tbody>
</table>
</div></div><div class="chart-card"><div class="chart-slot" id="chart-6"></div></div><div class="chart-card"><div class="chart-slot" id="chart-7"></div></div><div class="chart-card"><div class="chart-slot" id="chart-8"></div></div><div class="chart-card"><div class="chart-slot" id="chart-9"></div></div><div class="chart-card"><div class="chart-slot" id="chart-10"></div></div><div class="chart-card"><div class="chart-slot" id="chart-11"></div></div><div class="chart-card"><div class="chart-slot" id="chart-12"></div></div><div class="chart-card"><div class="chart-slot" id="chart-13"></div></div><div class="chart-card"><div class="chart-slot" id="chart-14"></div></div><div class="chart-card"><div class="chart-slot" id="chart-15"></div></div></div></div></section>
<script>
(function(){
  const MIN_PX = 6;     // allow very small to ensure full visibility
  const MAX_PX = 24;    // sensible upper bound
  const TITLE_MAX = 28;

  function fitElement(el, maxPx, minPx){
    if(!el) return;
    // Start high, then shrink via binary search
    let low = minPx, high = maxPx, best = minPx;
    // temporarily ensure measurement environment
    el.style.whiteSpace = 'nowrap';
    // binary search for the largest size that fits
    for(let i=0;i<20;i++){
      const mid = (low+high)/2;
      el.style.fontSize = mid + 'px';
      // Force reflow
      const fits = el.scrollWidth <= el.clientWidth + 0.5;
      if(fits){
        best = mid;
        low = mid;
      } else {
        high = mid;
      }
      if (Math.abs(high-low) < 0.25) break;
    }
    el.style.fontSize = best + 'px';
  }

  function fitRunsTable(){
    const root = document.querySelector('#chart-1 .runs-table');
    if(!root) return;
    const tds = root.querySelectorAll('td');
    // Set them briefly to MAX so we measure natural width first
    tds.forEach(td => { td.style.fontSize = MAX_PX + 'px'; });
    // Fit each cell to its column box
    tds.forEach(td => fitElement(td, MAX_PX, MIN_PX));

    // Also fit the title
    const title = document.querySelector('#chart-1 .runs-title');
    if(title){
      title.style.fontSize = TITLE_MAX + 'px';
      fitElement(title, TITLE_MAX, MIN_PX);
    }
  }

  const debounced = (fn, ms=50) => {
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms); };
  };

  function installObservers(){
    const container = document.getElementById('chart-1');
    if(!container) return;

    // ResizeObserver for container size changes
    if('ResizeObserver' in window){
      const ro = new ResizeObserver(debounced(fitRunsTable, 50));
      ro.observe(container);
    } else {
      window.addEventListener('resize', debounced(fitRunsTable, 100));
    }

    // MutationObserver to refit when values change
    const mo = new MutationObserver(debounced(fitRunsTable, 20));
    mo.observe(container, { subtree: true, characterData: true, childList: true });

    // Initial fit
    requestAnimationFrame(fitRunsTable);
    window.addEventListener('load', fitRunsTable);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', installObservers);
  } else {
    installObservers();
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
// Reuse existing Google Charts + loadViaJSONP flow, but fetch all cols and read index 92 (Col93)

  // Background store for Col87 (time per run) & Col88 (date EST)
  window.col8788Store = { times: [], dates: [], col94: [], col16: [], col97: null, col97_seconds: null, col97_10: null, col97_10_seconds: null, col97_100: null, col97_100_seconds: null, col97_1000: null, col97_1000_seconds: null, col97_fastest: null, col97_fastest_seconds: null, col97_slowest: null, col97_slowest_seconds: null, col97_total_dhm: null, col97_total_seconds: null, pairs1694: [], time_nether: [], loaded: false };

  (function(){
  function startAutoFill(){
    if (typeof chartsReady !== 'undefined' && chartsReady === true && typeof loadViaJSONP === 'function') {
      try {
        loadViaJSONP(GID_PROCESSED, "handleRunsTop5", "select * limit 5");
              // Background load of ALL rows for Col87 (time/run) and Col88 (date EST)
        loadViaJSONP(GID_PROCESSED, "handleCols8788", "select *");
} catch(e) {
        console.error("loadViaJSONP failed:", e);
      }
    } else {
      setTimeout(startAutoFill, 80);
    }
  }

  
window.handleRunsTop5 = function(response){
  try{
    if (!response || response.status !== "ok") {
      console.error("RunsTop5 response not ok:", response);
      const cell = document.getElementById('runs-completed');
      if (cell && !cell.textContent.trim()) cell.textContent = '—';
      if (typeof window.updateStats === 'function') window.updateStats();
      return;
    }
    const dt = new google.visualization.DataTable(response.table);
    const targetCol = 92; // zero-based index => column 93
    const rows = dt.getNumberOfRows();
    const cols = dt.getNumberOfColumns();
    console.log("[AutoFill] rows:", rows, "cols:", cols, "reading col index:", targetCol);

    if (targetCol >= cols) {
      console.error("Target column 93 not found. Columns available:", cols);
      const cell = document.getElementById('runs-completed');
      if (cell && !cell.textContent.trim()) cell.textContent = '—';
      if (typeof window.updateStats === 'function') window.updateStats();
      return;
    }
    const values = [];
    // Emulate existing code pattern: skip first data row if needed
    for (let r = 1; r < Math.min(rows, 5); r++) { // first 5 rows, starting at 1
      const v = dt.getValue(r, targetCol);
      if (v == null) continue;
      const num = typeof v === 'number' ? v : parseInt(String(v).replace(/,/g, ''), 10);
      if (!isNaN(num)) values.push(num);
    }
    const maxVal = values.length ? Math.max.apply(null, values) : null;
    console.log("[AutoFill] Col93 top5 (skipping row 0):", values, "max:", maxVal);
    const cell = document.getElementById('runs-completed');
    if (cell) cell.textContent = (maxVal != null ? maxVal : '—');
    if (typeof window.updateStats === 'function') window.updateStats();
  } catch(e){
    console.error("RunsTop5 handler error:", e);
    const cell = document.getElementById('runs-completed');
    if (cell && !cell.textContent.trim()) cell.textContent = '—';
    if (typeof window.updateStats === 'function') window.updateStats();
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
;
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startAutoFill);
  } else {
    startAutoFill();
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
(function(){
  function toNumber(text){
    if (text == null) return NaN;
    const n = parseInt(String(text).replace(/,/g,'').trim(), 10);
    return isNaN(n) ? NaN : n;
  }
  function fmt(n){ return n.toLocaleString ? n.toLocaleString() : String(n); }

  window.updateStats = function(){
    const rcEl = document.getElementById('runs-completed');
    const trEl = document.getElementById('total-remaining');
    const pdEl = document.getElementById('percentage-done');
    if (!rcEl) return;
    const rc = toNumber(rcEl.textContent);
    if (!isFinite(rc)) {
      if (trEl) trEl.textContent = '—';
      if (pdEl) pdEl.textContent = '—';
      return;
    }
    const remaining = Math.max(0, 100000 - Math.max(0, Math.min(100000, rc)));
    if (trEl) trEl.textContent = fmt(remaining);
    const pct = (rc / 100000) * 100;
    if (pdEl) pdEl.textContent = pct.toFixed(2) + "%";

    // Trigger resize/autofit if needed
    if (typeof requestAnimationFrame === 'function') {
      requestAnimationFrame(() => {
        if (typeof window !== 'undefined' && window.dispatchEvent) {
          window.dispatchEvent(new Event('resize'));
        }
      });
    }
  };

  // Run once on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(window.updateStats, 50));
  } else {
    setTimeout(window.updateStats, 50);
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
(function(){
  function getInnerWidth(el){
    if (!el) return 0;
    const cs = getComputedStyle(el);
    const pad = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
    return Math.max(0, el.clientWidth - pad);
  }

  function maximizeSingleLine(el){
    if (!el) return;
    const container = el.parentElement; // .chart-slot
    const maxWidth = getInnerWidth(container) || container.clientWidth || el.offsetWidth;
    if (!maxWidth) return;

    let lo = 6, hi = 96, best = lo;
    // Warm start: try something big first to avoid too-small look
    el.style.fontSize = hi + "px";
    // Binary search for largest size that fits on one line
    for (let i = 0; i < 20; i++) {
      const mid = (lo + hi) / 2;
      el.style.fontSize = mid + "px";
      const fits = el.scrollWidth <= maxWidth + 0.5; // small fudge
      if (fits) { best = mid; lo = mid; } else { hi = mid; }
      if (Math.abs(hi - lo) < 0.25) break;
    }
    el.style.fontSize = best + "px";
  }

  function fitChart2Title(){
  // Only resize Chart-2's title; leave others (e.g., Chart-1) alone
  document.querySelectorAll("#chart-2 h3").forEach(maximizeSingleLine);
}

  // Keep the title maximized as container resizes or layout changes
  function installObservers(){
    const chart2 = document.getElementById("chart-2");
    if (chart2 && "ResizeObserver" in window) {
      const ro = new ResizeObserver(() => fitChart2Title());
      ro.observe(chart2);
    } else {
      window.addEventListener("resize", fitChart2Title);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => { fitChart2Title(); installObservers(); });
  } else {
    fitChart2Title(); installObservers();
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
// === BEGIN handleCols8788 (group & average by EST date) ===
window.handleCols8788 = function(response) {
  try {
    if (!response || response.status !== "ok") {
      console.error("[Cols87/88] response not ok:", response);
      return;
    }
    const dt = new google.visualization.DataTable(response.table);
    const rows = dt.getNumberOfRows();
    const cols = dt.getNumberOfColumns();
    const c87 = 86; // zero-based index for column 87 (time per run h:mm:ss)
    const c88 = 87; // zero-based index for column 88 (date played EST)
    const c94 = 93; // zero-based index for column 94
    const c16 = 15; // zero-based index for column 16 (h:mm:ss.mmm)
    const c9 = 8;  // zero-based index for column 9 (time_nether)
    if (c87 >= cols || c88 >= cols) {
      console.error("[Cols87/88] Missing expected columns. Available:", cols);
      return;
    }

    const times = [];
    const time_nether = [];
    const dates = [];
    const col94 = [];
    const col16 = [];
    const pairs1694 = [];
    for (let r = 1; r < rows; r++) {
      const t = dt.getValue(r, c87);
      const d = dt.getValue(r, c88);
      const v94 = dt.getValue(r, c94);
      const v16 = dt.getValue(r, c16);
      const v9 = (c9 < cols) ? dt.getValue(r, c9) : null;
      if (t != null) times.push(String(t));
      if (d != null) dates.push(String(d));
      if (v94 != null) col94.push(String(v94));
      if (v16 != null) {
      var str16;
      if (v16 instanceof Date) {
        var hh = v16.getHours();
        var mm = String(v16.getMinutes()).padStart(2, '0');
        var ss = String(v16.getSeconds()).padStart(2, '0');
        str16 = hh + ':' + mm + ':' + ss;
      } else {
        str16 = String(v16);
      }
      col16.push(str16);
      pairs1694.push({ t16: str16, c94: (v94 == null ? null : String(v94)) });
    }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}


    console.log("[Cols87] first 3:", times.slice(0,3));
    console.log("[Cols88] first 3:", dates.slice(0,3));

    if (!window.col8788Store) window.col8788Store = { times: [], dates: [], col94: [], col16: [], col97: null, col97_seconds: null, col97_10: null, col97_10_seconds: null, col97_100: null, col97_100_seconds: null, col97_1000: null, col97_1000_seconds: null, col97_fastest: null, col97_fastest_seconds: null, col97_slowest: null, col97_slowest_seconds: null, col97_total_dhm: null, col97_total_seconds: null, pairs1694: [], time_nether: [], loaded: false };
    window.col8788Store.times = times;
    window.col8788Store.dates = dates;
    window.col8788Store.col94 = col94;
        window.col8788Store.col16 = col16;
    window.col8788Store.pairs1694 = pairs1694;
    window.col8788Store.time_nether = time_nether;
    function fmtTimeNether(val){
      if (val == null) return null;
      var d = null;
      if (val instanceof Date) {
        d = val;
      } else if (typeof val === 'number') {
        // Sheets number as fraction-of-day
        d = new Date(Math.round(val * 86400) * 1000);
      } else if (typeof val === 'string') {
        var tryDate = new Date(val);
        if (!isNaN(tryDate)) d = tryDate;
      }
      if (d) {
        var h = d.getHours();
        var m = String(d.getMinutes()).padStart(2,'0');
        var s = String(d.getSeconds()).padStart(2,'0');
        var ms = String(d.getMilliseconds()).padStart(3,'0');
        return h + ':' + m + ':' + s + '.' + ms;
      }
      return String(val);
    }
    console.log("[Col9 time_nether] first 5:", time_nether.slice(0,5));
window.col8788Store.loaded = true;

    function parseHMS(str) {
      if (!str) return null;
      const m = String(str).trim().match(/^(\d+):([0-5]?\d):([0-5]?\d)$/);
      if (!m) return null;
      const h = parseInt(m[1], 10);
      const mi = parseInt(m[2], 10);
      const s = parseInt(m[3], 10);
      return h * 3600 + mi * 60 + s;
    }
    function fmtHMS(total) {
      if (total == null || isNaN(total)) return null;
      total = Math.round(total);
      const h = Math.floor(total / 3600);
      const rem = total % 3600;
      const m = Math.floor(rem / 60);
      const s = rem % 60;
      return h + ":" + String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    // Format any value into 'h:mm:ss.mmm'
    function fmtHMSmsFromVal(val){
      if (val == null) return null;
      var d = null;
      if (val instanceof Date) {
        d = val;
      } else if (typeof val === 'number' && isFinite(val)) {
        // Treat as fraction-of-day to milliseconds
        var ms = Math.round(val * 86400 * 1000);
        d = new Date(ms);
      } else if (typeof val === 'string') {
        var tryDate = new Date(val);
        if (!isNaN(tryDate)) d = tryDate;
      }
      if (!d) return null;
      var h = d.getHours();
      var m = String(d.getMinutes()).padStart(2,'0');
      var s = String(d.getSeconds()).padStart(2,'0');
      var ms = String(d.getMilliseconds()).padStart(3,'0');
      return h + ':' + m + ':' + s + '.' + ms;
    }

    const groups = new Map();
    const n = Math.min(times.length, dates.length);
    for (let i = 0; i < n; i++) {
      const secs = parseHMS(times[i]);
      const raw = dates[i];
      if (secs == null || !raw) continue;
      const parts = String(raw).trim().split(/\s+/);
      const displayDate = parts[0] || "";
      const g = groups.get(displayDate);
      if (g) {
        g.sum += secs; g.count += 1;
      } else {
        groups.set(displayDate, { sum: secs, count: 1 });
      }
    }

    const averages = [];
    for (const [displayDate, acc] of groups.entries()) {
      if (acc.count >= 5) { // Only include dates with 5 or more runs
        const avg = acc.sum / acc.count;
        averages.push({ displayDate, avgSeconds: avg, avgHMS: fmtHMS(avg), count: acc.count });
      }
    }

    averages.sort((a, b) => a.avgSeconds - b.avgSeconds);

    

    
    // Expose for Chart 2 renderer
    window.col8788AveragesByDate = averages;
// Now that the array is ready, render into Chart 2 when the DOM is ready
    const runPopulate = () => populateChart2TopN(5);
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runPopulate, { once:true });
    } else {
      runPopulate();
    }
    console.log("[Cols87 by Date, n>=5, shortest->longest] first 3 averages:", averages.slice(0, 10).map(x => ({ date: x.displayDate, avg: x.avgHMS, n: x.count })));
  } catch (e) {
    console.error("[Cols87/88] handler error:", e);
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
;

    // Patched Chart 2 population block will be inserted below </script>
<script>
// Fill the first N rows of Chart 2 from window.col8788AveragesByDate
function populateChart2TopN(n = 5){
  try{
    const arr = Array.isArray(window.col8788AveragesByDate) ? window.col8788AveragesByDate : [];
    if (!arr.length) return; // nothing to render yet

    const tbody = document.querySelector('#chart-2 table.runs-table tbody');
    if (!tbody) return;

    // take the first n ranked items and map into the first n rows
    const rows = Array.from(tbody.querySelectorAll('tr')).slice(0, n);
    arr.slice(0, n).forEach((item, idx) => {
      const cells = rows[idx] ? rows[idx].querySelectorAll('td') : null;
      if (!cells || cells.length < 4) return;
      
      // center the # of Runs column without affecting global CSS
      if (cells[1]) { cells[1].style.textAlign = 'center'; cells[1].style.whiteSpace = 'nowrap'; }
cells[0].textContent = String(item.displayDate || '—');  // Date
      cells[1].textContent = String(item.count ?? '—');        // # of Runs
      cells[2].textContent = String(item.avgHMS || '—');       // Average Time
      cells[3].textContent = String(idx + 1);                  // Rank
    });
  } catch(e){
    console.error("[Chart2 Populate] error:", e);
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}

</script>
<script>
// Shrink-to-fit utility specifically for Chart 2 cells
(function(){
  function fitText(el, opts){
    if (!el) return;
    const minPx = (opts && opts.minPx) || 10;
    const maxPx = (opts && opts.maxPx) || 16;
    const step  = (opts && opts.step)  || 0.5;
    // Reset to max first so we can shrink down
    el.style.fontSize = maxPx + 'px';
    // If it already fits, done
    if (el.scrollWidth <= el.clientWidth) return;
    // Shrink until it fits or we hit min
    let size = maxPx;
    let guard = 0;
    while (size > minPx && el.scrollWidth > el.clientWidth && guard < 100){
      size -= step;
      el.style.fontSize = size + 'px';
      guard++;
    }
  }

  // Expose for populateChart2TopN to call per-cell
  window.__fitChart2CellText = fitText;

  // Refit on resize for robustness
  const chart2 = document.querySelector('#chart-2 table.runs-table');
  if (chart2 && 'ResizeObserver' in window){
    const ro = new ResizeObserver(() => {
      const rows = chart2.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells[0]) window.__fitChart2CellText(cells[0], {minPx:10, maxPx:16, step:0.5});
        if (cells[1]) window.__fitChart2CellText(cells[1], {minPx:10, maxPx:16, step:0.5});
      });
    });
    ro.observe(chart2);
  } else {
    // Fallback: refit on window resize
    window.addEventListener('resize', () => {
      const rows = document.querySelectorAll('#chart-2 table.runs-table tbody tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells[0]) window.__fitChart2CellText(cells[0], {minPx:10, maxPx:16, step:0.5});
        if (cells[1]) window.__fitChart2CellText(cells[1], {minPx:10, maxPx:16, step:0.5});
      });
    });
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
(function(){
  // Parse time formats seen in Col87 ("h:mm:ss" or Date/number edge cases)
  function parseToSeconds(v){
    if (v == null) return null;
    if (v instanceof Date){
      return v.getHours()*3600 + v.getMinutes()*60 + v.getSeconds() + (v.getMilliseconds()||0)/1000;
    }
    if (typeof v === 'number' && isFinite(v)){
      // Google Sheets day-fraction -> seconds
      if (v > 0 && v < 2) return v * 86400;
      return v; // assume already seconds
    }
    var s = String(v).trim();
    // sometimes looks like "0:12:34" or "00:12:34.5"
    var m = s.match(/^(\d+):([0-5]?\d):([0-5]?\d)(?:\.(\d{1,3}))?$/);
    if (m){
      var h = parseInt(m[1],10), mi = parseInt(m[2],10), se = parseInt(m[3],10);
      var ms = m[4] ? parseInt((m[4] + '000').slice(0,3),10) : 0;
      return h*3600 + mi*60 + se + ms/1000;
    }
    // sometimes looks like "00:12:34 — XX" (defensive)
    var parts = s.split(' ').shift();
    var m2 = parts && parts.match(/^(\d+):([0-5]?\d):([0-5]?\d)$/);
    if (m2){
      var h2 = parseInt(m2[1],10), mi2 = parseInt(m2[2],10), se2 = parseInt(m2[3],10);
      return h2*3600 + mi2*60 + se2;
    }
    return null;
  }
  function fmtHMS(sec){
    if (sec == null || !isFinite(sec)) return '—';
    var s = Math.max(0, sec);
    var h = Math.floor(s/3600); s -= h*3600;
    var m = Math.floor(s/60); s -= m*60;
    var ss = Math.floor(s + 1e-6);
    function pad2(n){ return String(n).padStart(2,'0'); }
    return h + ':' + pad2(m) + ':' + pad2(ss);
  }
  function fmtDate(v){
    if (v == null) return '—';
    if (v instanceof Date){
      var y=v.getFullYear(), m=v.getMonth()+1, d=v.getDate();
      function pad2(n){ return String(n).padStart(2,'0'); }
      return pad2(m) + '/' + pad2(d) + '/' + y;
    }
    // allow ISO or MM/DD/YYYY to pass through
    
        var str = String(v).trim();
        // Try to detect ISO or MM/DD/YYYY HH:MM:SS and strip time if present
        if (/^\d{4}-\d{2}-\d{2}T/.test(str)){
          // ISO string with time
          var d = new Date(str);
          if (!isNaN(d)) return (('0'+(d.getMonth()+1)).slice(-2) + '/' + ('0'+d.getDate()).slice(-2) + '/' + d.getFullYear());
        }
        // If looks like MM/DD/YYYY HH:MM:SS just take first 10 chars
        if (/^\d{2}\/\d{2}\/\d{4}/.test(str)) return str.slice(0,10);
        return str;
        
  }

  // Handler for JSONP: read col 87 (time), 93 (run number), 88 (date EST)
  window.handleTop10Chart4 = function(response){
    try{
      if (!response || response.status !== 'ok') {
        console.error('[Chart-4 Top10] response not ok:', response);
        return;
      }
      var dt = new google.visualization.DataTable(response.table);
      var rows = dt.getNumberOfRows();
      var cols = dt.getNumberOfColumns();
      var C_TIME = 86; // col 87 zero-based
      var C_DATE = 87; // col 88
      var C_RUN  = 92; // col 93
      if (C_TIME >= cols || C_DATE >= cols || C_RUN >= cols){
        console.error('[Chart-4 Top10] missing expected columns:', cols);
        return;
      }
      var items = [];
      for (var r=1; r<rows; r++){ // skip first data row, consistent with other handlers
        var t = dt.getValue(r, C_TIME);
        var d = dt.getValue(r, C_DATE);
        var run = dt.getValue(r, C_RUN);
        var secs = parseToSeconds(t);
        // normalize run as integer when string like "12,345"
        var runNum = null;
        if (typeof run === 'number') runNum = run;
        else if (typeof run === 'string'){
          var num = parseInt(run.replace(/,/g,''), 10);
          if (!isNaN(num)) runNum = num;
        }
        if (secs != null && isFinite(secs) && runNum != null){
          items.push({ seconds: secs, timeStr: fmtHMS(secs), run: runNum, dateStr: fmtDate(d) });
        }
      }
      // sort ascending (fastest first)
      items.sort(function(a,b){ return a.seconds - b.seconds; });
      var top = items.slice(0, 10);

      // Populate chart-4 table
      var tbody = document.querySelector('#chart-4 table.runs-table tbody');
      if (!tbody){
        console.warn('[Chart-4 Top10] tbody not found');
        return;
      }
      var rowsDom = tbody.querySelectorAll('tr');
      for (var i=0; i<10; i++){
        var tr = rowsDom[i] || null;
        var cells = tr ? tr.querySelectorAll('td') : null;
        var row = top[i];
        if (cells && cells.length >= 3){
          // Day (Date), Time, Run — keep centered via inline style
          cells[0].textContent = row ? row.dateStr : '—';
          cells[1].textContent = row ? row.timeStr : '—';
          cells[2].textContent = row ? String(row.run) : '—';
        }
      }
      console.log('[Chart-4 Top10] populated', top);
    }catch(e){
      console.error('[Chart-4 Top10] error:', e);
    }
  };

  // Boot loader: wait for chartsReady & loadViaJSONP, then fetch
  (function boot(){
    function ready(){
      try{
        return (typeof google !== 'undefined' && google.visualization)
               && (typeof chartsReady !== 'undefined' && chartsReady === true)
               && (typeof loadViaJSONP === 'function');
      }catch(e){ return false; }
    }
    function start(){
      try{
        // fetch ALL cols so indices are stable
        loadViaJSONP(GID_PROCESSED, 'handleTop10Chart4', 'select *');
      }catch(e){
        console.error('[Chart-4 Top10] loadViaJSONP failed:', e);
      }
    }
    if (ready()) start();
    else {
      var tries = 0, max = 600;
      var iv = setInterval(function(){
        if (ready() || ++tries >= max){
          clearInterval(iv);
          if (ready()) start();
        }
      }, 200);
      setTimeout(function(){ clearInterval(iv); }, 130000);
    }
  })();
})();
</script>

<script>
// === Stable dynamic table/text fitting for Chart-3 and Chart-4 (debounced, no layout thrash) ===
(function(){
  const MIN_PX = 10;
  const MAX_PX = 18;
  const EPS = 0.5;

  function fitCell(el, minPx=MIN_PX, maxPx=MAX_PX){
    if (!el) return;
    if (el.dataset.fitting === "1") return;
    el.dataset.fitting = "1";

    const prevWS = el.style.whiteSpace;
    el.style.whiteSpace = 'nowrap';

    let lo = minPx, hi = maxPx, best = minPx;
    // Binary search for max size that fits once; avoid repeated writes
    for (let i=0;i<18;i++){
      const mid = (lo + hi) / 2;
      el.style.fontSize = mid + 'px';
      const fits = el.scrollWidth <= el.clientWidth + EPS;
      if (fits){ best = mid; lo = mid; } else { hi = mid; }
      if (Math.abs(hi - lo) < 0.25) break;
    }

    // Only apply if changed significantly
    const current = parseFloat((el.style.fontSize || maxPx).toString());
    if (Math.abs(current - best) > 0.2){
      el.style.fontSize = best + 'px';
    }
    el.style.whiteSpace = prevWS;
    el.dataset.fitting = "";
  }

  function stableFitTitle(title){
    if (!title) return;
    const slot = title.parentElement;
    if (!slot) return;
    const lastWidth = parseFloat(title.dataset.lastSlotWidth || "-1");
    const w = slot.clientWidth || 0;
    // Only recompute if width actually changed
    if (Math.abs(w - lastWidth) < 1) return;

    title.dataset.lastSlotWidth = String(w);
    const prevWS = title.style.whiteSpace;
    title.style.whiteSpace = 'nowrap';
    let lo = 10, hi = 36, best = lo;
    for (let i=0;i<20;i++){
      const mid = (lo + hi) / 2;
      title.style.fontSize = mid + 'px';
      const fits = title.scrollWidth <= w + EPS;
      if (fits){ best = mid; lo = mid; } else { hi = mid; }
      if (Math.abs(hi-lo) < 0.25) break;
    }
    title.style.fontSize = best + 'px';
    title.style.whiteSpace = prevWS;
  }

  function fitTable(containerId){
    const root = document.querySelector(containerId + ' .runs-table');
    if (!root) return;
    // Fit headers then cells
    root.querySelectorAll('th, td').forEach(c => fitCell(c));
    // Fit local title if present
    stableFitTitle(document.querySelector(containerId + ' .runs-title'));
  }

  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(fn, ms); }; }

  function install(containerId){
    const container = document.querySelector(containerId);
    if (!container) return;

    const doFit = debounce(() => fitTable(containerId), 60);

    // ResizeObserver: only refit on actual size change (width/height)
    let lastW = -1, lastH = -1;
    if ('ResizeObserver' in window){
      const ro = new ResizeObserver(() => {
        const r = container.getBoundingClientRect();
        if (Math.abs(r.width - lastW) > 1 || Math.abs(r.height - lastH) > 1){
          lastW = r.width; lastH = r.height;
          doFit();
        }
      });
      ro.observe(container);
      const table = container.querySelector('.runs-table');
      if (table) ro.observe(table);
    } else {
      window.addEventListener('resize', doFit);
    }

    // MutationObserver: watch content changes, NOT attributes (to avoid feedback on style changes)
    const table = container.querySelector('.runs-table') || container;
    const mo = new MutationObserver(doFit);
    mo.observe(table, { subtree: true, characterData: true, childList: true });

    // Initial fit
    requestAnimationFrame(doFit);
    window.addEventListener('load', doFit);
  }

  // Install on Chart-3, Chart-4, and Chart-5
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      install('#chart-3');
      install('#chart-4');
    install('#chart-5');
      install('#chart-5');
    }, { once:true });
  } else {
    install('#chart-3');
    install('#chart-4');
    install('#chart-5');
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>


<script>
(function(){
  const pill  = document.getElementById('twitch-live-pill');
  const dot   = document.getElementById('twitch-live-dot');
  const label = document.getElementById('twitch-live-text');

  async function checkLive(){
    try{
      const res  = await fetch('https://decapi.me/twitch/uptime/couriway', { cache: 'no-store' });
      const text = (await res.text()).trim().toLowerCase();
      const isLive = res.ok && text && !text.includes('offline');

      pill.classList.toggle('is-live', isLive);
      pill.classList.toggle('is-off', !isLive);

      label.textContent = isLive ? 'LIVE' : 'Offline';
      pill.title = isLive ? 'Couriway is live on Twitch' : 'Couriway is offline on Twitch';
    }catch(e){
      pill.classList.remove('is-live','is-off');
      label.textContent = 'Status unavailable';
      pill.title = 'Unable to fetch Twitch status';
    }
  }

  checkLive();
  setInterval(checkLive, 60000);
})();
</script>


<script>
// === Chart-5: Nether Entries metrics ===
(function(){
  function parseHMSms(str){
    if (!str) return null;
    const m = String(str).trim().match(/^(\d+):([0-5]?\d):([0-5]?\d)\.(\d{1,3})$/);
    if (!m) return null;
    const h = parseInt(m[1], 10);
    const mi = parseInt(m[2], 10);
    const s = parseInt(m[3], 10);
    const ms = parseInt(m[4].padEnd(3,'0'), 10);
    return h*3600 + mi*60 + s + ms/1000;
  }
  function fmtHMSms(total){
    if (total == null || isNaN(total)) return '—';
    const h = Math.floor(total / 3600);
    const rem = total - h*3600;
    const m = Math.floor(rem / 60);
    const s = Math.floor(rem - m*60);
    const ms = Math.round((total - Math.floor(total)) * 1000);
    return h + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0") + "." + String(ms).padStart(3,"0");
  }
  function averageSeconds(arr){
    if (!arr.length) return null;
    let sum = 0, count = 0;
    for (let i=0;i<arr.length;i++){
      const v = parseHMSms(arr[i]);
      if (v != null){ sum += v; count++; }
    }
    return count ? (sum / count) : null;
  }
  function computeChart5(){
    try{
      const store = window.col8788Store || {};
      if (!store.loaded) return false;
      const times = Array.isArray(store.time_nether) ? store.time_nether : [];
      const flags = Array.isArray(store.col94) ? store.col94 : [];
      if (!times.length) return true; // no data but stop retry
      // 1) Averages excluding rows where col94 === "false"
      const keepIdx = [];
      for (let i=0;i<times.length;i++){
        const f = (flags[i]==null ? "" : String(flags[i])).trim().toLowerCase();
        if (f !== "true") keepIdx.push(i);
      }
      const keptTimes = keepIdx.map(i => times[i]);
      // Overall average
      const avgAll = averageSeconds(keptTimes);
      const el1 = document.getElementById("chart5-entry1");
      if (el1) el1.textContent = fmtHMSms(avgAll);
      // Last 10 / 100 / 1000 from kept order (first N like Chart-3 convention)
      function sliceN(list, n){ return list.slice(0, Math.min(n, list.length)); }
      const avg10   = averageSeconds(sliceN(keptTimes, 10));
      const avg100  = averageSeconds(sliceN(keptTimes, 100));
      const avg1000 = averageSeconds(sliceN(keptTimes, 1000));
      const el2 = document.getElementById("chart5-entry2");
      const el3 = document.getElementById("chart5-entry3");
      const el4 = document.getElementById("chart5-entry4");
      if (el2) el2.textContent = fmtHMSms(avg10);
      if (el3) el3.textContent = fmtHMSms(avg100);
      if (el4) el4.textContent = fmtHMSms(avg1000);
      // 2) Fastest / Slowest excluding the bottom 3000 rows of column 9
      const cutoff = Math.max(0, times.length - 3000);
      const trimmed = times.slice(0, cutoff);
      let fastest = null, slowest = null;
      for (let i=0;i<trimmed.length;i++){
        const v = parseHMSms(trimmed[i]);
        if (v == null) continue;
        if (fastest == null || v < fastest) fastest = v;
        if (slowest == null || v > slowest) slowest = v;
      }
      const el5 = document.getElementById("chart5-entry5");
      const el6 = document.getElementById("chart5-entry6");
      if (el5) el5.textContent = fmtHMSms(fastest);
      if (el6) el6.textContent = fmtHMSms(slowest);
      console.log("[Chart-5] avgAll:", fmtHMSms(avgAll), "avg10:", fmtHMSms(avg10), "avg100:", fmtHMSms(avg100), "avg1000:", fmtHMSms(avg1000), "fastest (cutoff3000):", fmtHMSms(fastest), "slowest (cutoff3000):", fmtHMSms(slowest));
      // Trigger a resize/fitting pass
      try{ if (typeof window !== 'undefined' && window.dispatchEvent){ window.dispatchEvent(new Event('resize')); } }catch(_e){}
      return true;
    }catch(e){
      console.error("[Chart-5] compute error:", e);
      return true; // stop retries on code error
    }
  }
  if (!computeChart5()){
    const iv = setInterval(function(){ if (computeChart5()) clearInterval(iv); }, 200);
    setTimeout(function(){ clearInterval(iv); }, 15000);
  }
})();
</script>

</body>
</html>
<script>
(function(){
  function logOnce(){
    try{
      if (window.col8788Store && Array.isArray(window.col8788Store.col94) && window.col8788Store.col94.length){
        console.log("First 100 items from Col94:", window.col8788Store.col94.slice(0, 100));
        return true;
      }
    }catch(e){}
    return false;
  }
  if (!logOnce()){
    var iv = setInterval(function(){
      if (logOnce()) clearInterval(iv);
    }, 200);
    setTimeout(function(){ clearInterval(iv); }, 15000);
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
<script>
(function(){
  
function toSecondsFromCol16(val){
  if (val == null) return null;
  // Date object from Google DataTable (e.g., Sat Dec 30 1899 00:25:54 ...)
  if (val instanceof Date){
    return val.getHours()*3600 + val.getMinutes()*60 + val.getSeconds() + (val.getMilliseconds()||0)/1000;
  }
  // Numeric fraction-of-day (Excel/Sheets style): 1 day == 86400 seconds
  if (typeof val === 'number' && isFinite(val)){
    return val * 86400;
  }
  // String formats: h:mm:ss.mmm or h:mm:ss
  var s = String(val).trim();
  var m = s.match(/^(\d+):([0-5]?\d):([0-5]?\d)(?:\.(\d{1,3}))?$/);
  if (m){
    var h = parseInt(m[1],10), mi = parseInt(m[2],10), se = parseInt(m[3],10);
    var ms = m[4] != null ? parseInt((m[4] + '000').slice(0,3),10) : 0;
    return h*3600 + mi*60 + se + ms/1000;
  }
  m = s.match(/^(\d+):([0-5]?\d):([0-5]?\d)$/);
  if (m){
    var h2 = parseInt(m[1],10), mi2 = parseInt(m[2],10), se2 = parseInt(m[3],10);
    return h2*3600 + mi2*60 + se2;
  }
  return null;
}
  function fmtHMS(secs){
    if (secs == null || !isFinite(secs)) return null;
    secs = Math.round(secs);
    var h = Math.floor(secs / 3600);
    var rem = secs % 3600;
    var m = Math.floor(rem / 60);
    var s = rem % 60;
    return h + ":" + String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }
  function toDHM(total){
    if (!isFinite(total)) return null;
    total = Math.floor(total);
    var days = Math.floor(total / 86400);
    var remD = total % 86400;
    var hours = Math.floor(remD / 3600);
    var remH = remD % 3600;
    var mins = Math.floor(remH / 60);
    return { days: days, hours: hours, mins: mins };
  }
  function compute(){
    try{
      var store = window.col8788Store || {};
      if (!store.loaded || !Array.isArray(store.col16) || !Array.isArray(store.col94)) return false;
      var pairs = (Array.isArray(store.pairs1694) && store.pairs1694.length) ? store.pairs1694
                 : store.col16.map(function(t16, idx){ return { t16: String(t16), c94: (store.col94[idx] != null ? String(store.col94[idx]) : null) };
});
      console.log("[Chart-3] First 10 Col16 values:", (window.col8788Store && window.col8788Store.col16) ? window.col8788Store.col16.slice(0,10) : []);
      var keep = pairs.filter(function(p){
        return !(String(p.c94 || "").trim().toLowerCase() === "true");
      });
      function avgSeconds(arr){
        var sum = 0, count = 0;
        for (var i=0;i<arr.length;i++){
          var secs = toSecondsFromCol16(arr[i].t16);
          if (typeof secs === "number" && isFinite(secs)){ sum += secs; count++; }
        }
        return count ? (sum / count) : null;
      }
      var avgAll = avgSeconds(keep);
      var avg10 = avgSeconds(keep.slice(0,10));
      var avg100 = avgSeconds(keep.slice(0,100));
      var avg1000 = avgSeconds(keep.slice(0,1000));
      var secsArr = keep.map(function(p){ return toSecondsFromCol16(p.t16); }).filter(function(v){ return typeof v === "number" && isFinite(v); });
      var fastest = secsArr.length ? Math.min.apply(null, secsArr) : null;
      var slowest = secsArr.length ? Math.max.apply(null, secsArr) : null;
      var totalSecs = secsArr.reduce(function(a,b){ return a+b; }, 0);
      var dhm = toDHM(totalSecs);
      var dhmStr = dhm ? (dhm.days + " days, " + dhm.hours + " hours, " + dhm.mins + " minutes") : null;

      // Save
      store.col97_seconds = avgAll; store.col97 = fmtHMS(avgAll);
      store.col97_10_seconds = avg10; store.col97_10 = fmtHMS(avg10);
      store.col97_100_seconds = avg100; store.col97_100 = fmtHMS(avg100);
      store.col97_1000_seconds = avg1000; store.col97_1000 = fmtHMS(avg1000);
      store.col97_fastest_seconds = fastest; store.col97_fastest = fmtHMS(fastest);
      store.col97_slowest_seconds = slowest; store.col97_slowest = fmtHMS(slowest);
      store.col97_total_seconds = totalSecs; store.col97_total_dhm = dhmStr;

      // Console
      console.log("[Chart-3] Average (all, Col16 after filtering):", store.col97, "(n=", keep.length, ")");
      console.log("[Chart-3] Average (first 10):", store.col97_10, "(n=", Math.min(10, keep.length), ")");
      console.log("[Chart-3] Average (first 100):", store.col97_100, "(n=", Math.min(100, keep.length), ")");
      console.log("[Chart-3] Average (first 1000):", store.col97_1000, "(n=", Math.min(1000, keep.length), ")");
      console.log("[Chart-3] Fastest run:", store.col97_fastest);
      console.log("[Chart-3] Slowest run:", store.col97_slowest);
      console.log("[Chart-3] Total time (D/H/M):", store.col97_total_dhm);

      // Wire DOM
      function setText(id, val){ var el = document.getElementById(id); if (el) el.textContent = (val != null ? val : '—'); }
      setText('chart3-avg', store.col97);
      setText('chart3-avg10', store.col97_10);
      setText('chart3-avg100', store.col97_100);
      setText('chart3-avg1000', store.col97_1000);
      setText('chart3-fastest', store.col97_fastest);
      setText('chart3-slowest', store.col97_slowest);
      setText('chart3-total', store.col97_total_dhm);
      return true;
    }catch(e){
      console.error("[Chart-3 compute] error:", e);
      return true; // stop retrying if code error to avoid spam
    }
  }
  if (!compute()){
    var iv = setInterval(function(){ if (compute()) clearInterval(iv); }, 200);
    setTimeout(function(){ clearInterval(iv); }, 15000);
  }
      if (v9 != null) {
        var tn = fmtHMSmsFromVal(v9);
        if (tn != null) time_nether.push(tn);
      }
}
)();
</script>
